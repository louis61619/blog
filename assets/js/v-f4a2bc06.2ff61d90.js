"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[325],{5146:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-f4a2bc06",path:"/front-end/vue/Reactivity.html",title:"Vue3響應式原理",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"實現一個渲染系統",slug:"實現一個渲染系統",children:[{level:3,title:"定義h函數來返回vnode節點",slug:"定義h函數來返回vnode節點",children:[]},{level:3,title:"mount函數進行掛載",slug:"mount函數進行掛載",children:[]},{level:3,title:"patch函數比對更新舊節點",slug:"patch函數比對更新舊節點",children:[]}]},{level:2,title:"如何實現一個響應式系統",slug:"如何實現一個響應式系統",children:[{level:3,title:"Dep類",slug:"dep類",children:[]},{level:3,title:"數據劫持",slug:"數據劫持",children:[]},{level:3,title:"watchEffect",slug:"watcheffect",children:[]}]},{level:2,title:"實現一個createApp函數",slug:"實現一個createapp函數",children:[]}],filePathRelative:"front-end/vue/Reactivity.md",git:{updatedTime:1641123391e3,contributors:[{name:"louis",email:"louis61619@gmail.com",commits:1}]}}},8711:(n,s,a)=>{a.r(s),a.d(s,{default:()=>kn});var t=a(6252),e=a(1139),o=a(3357);const c=(0,t._)("h1",{id:"vue3響應式原理",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#vue3響應式原理","aria-hidden":"true"},"#"),(0,t.Uk)(" Vue3響應式原理")],-1),p=(0,t._)("p",null,"Vue的三大核心模塊：",-1),l=(0,t._)("ul",null,[(0,t._)("li",null,[(0,t._)("p",null,"Compiler模塊(編譯系統)"),(0,t._)("p",null,"編譯template的系統，分為Runtime + Compiler和Runtime-only兩種，通常我們會使用Runtime-only，讓vue-loader幫我們將template轉化一般的javascript程式碼，也就是render函數")]),(0,t._)("li",null,[(0,t._)("p",null,"Render模塊(渲染系統)"),(0,t._)("p",null,"主要的工作是透過render函數生成vnode節點(虛擬DOM由多個vnode組成)，並且會進行diff算法更新被修改的vode節點")]),(0,t._)("li",null,[(0,t._)("p",null,"Reactivity模塊(響應式系統)"),(0,t._)("p",null,"組件內部會依賴一些，而數據改變時Reactivity模塊會調用render函數使vnode更新")])],-1),u=(0,t._)("p",null,[(0,t._)("img",{src:e,alt:"vuevirtualdomgraph"})],-1),k=(0,t._)("p",null,"三個模塊是這樣協同工作的",-1),_=(0,t._)("ul",null,[(0,t._)("li",null,"Compiler模塊會將template在編譯階段轉化成不同的render函數"),(0,t._)("li",null,"Render模塊將不同的render函數生成對應的vnode節點(虛擬DOM由多個vnode組成)，並將虛擬DOM渲染成真實DOM"),(0,t._)("li",null,"Reactivity模塊會監測數據的變化，如果出現變化會通知Render模塊"),(0,t._)("li",null,"Render模塊會對比新舊虛擬DOM的差別，然後使用diff算法將相應的vnode節點進行更新")],-1),i=(0,t._)("h2",{id:"實現一個渲染系統",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#實現一個渲染系統","aria-hidden":"true"},"#"),(0,t.Uk)(" 實現一個渲染系統")],-1),r=(0,t._)("p",null,"要實現一個簡單的渲染系統包含以下幾點",-1),U=(0,t._)("ul",null,[(0,t._)("li",null,"定義h函數來返回vnode節點"),(0,t._)("li",null,"mount函數進行掛載"),(0,t._)("li",null,"patch函數比對更新舊節點")],-1),b=(0,t._)("h3",{id:"定義h函數來返回vnode節點",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#定義h函數來返回vnode節點","aria-hidden":"true"},"#"),(0,t.Uk)(" 定義h函數來返回vnode節點")],-1),d=(0,t._)("p",null,"首先來寫一個h函數來定義一個vnode節點，一個vnode節點中應該包含tag(html標籤)、prop(屬性，EX: id、class、placeholder或者是監聽函數)、children(子節點)",-1),m=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token function-variable function"},"h"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("tag"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" props"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" children")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    tag"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    props"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    children\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br")])],-1),h=(0,t._)("h3",{id:"mount函數進行掛載",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#mount函數進行掛載","aria-hidden":"true"},"#"),(0,t.Uk)(" mount函數進行掛載")],-1),f=(0,t._)("p",null,"然後我們要寫一個mount函數將vnode掛載至頁面上，在這個mount函數中我們應該傳入兩個東西，一個vnode節點、一個是要掛載的標籤，這個函數要做的事情有以下幾點",-1),v=(0,t._)("ul",null,[(0,t._)("li",null,"在vnode節點中新增一個對應真實dom節點的屬性"),(0,t._)("li",null,"將props轉為相對應的屬性以及透過addEventListener監聽事件的發生"),(0,t._)("li",null,"遞歸將vnode內的子節點轉換成真實dom"),(0,t._)("li",null,"最後透過appendChild這個函數掛載到對應的標籤內")],-1),g=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token function-variable function"},"mount"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("vnode"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" container")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" el "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" document"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"createElement"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("tag"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 處理props"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"for"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" value "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"startsWith"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'on'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"addEventListener"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token number"},"2"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"toLowerCase"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" value"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"setAttribute"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" value"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n\n  "),(0,t._)("span",{class:"token comment"},"// 處理children"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"string"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("textContent "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"for"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" item "),(0,t._)("span",{class:"token keyword"},"of"),(0,t.Uk)(" vnode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("item"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(" \n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 將el掛載的container上"),(0,t.Uk)("\n  container"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"appendChild"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"29"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"30"),(0,t._)("br")])],-1),y=(0,t._)("p",null,"我們可以透過mount函數掛載vnode，以下做一個示例",-1),w=(0,t._)("p",null,"html",-1),j=(0,t._)("div",{class:"language-html ext-html line-numbers-mode"},[(0,t._)("pre",{class:"language-html"},[(0,t._)("code",null,[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"<"),(0,t.Uk)("div")]),(0,t.Uk)(),(0,t._)("span",{class:"token attr-name"},"id"),(0,t._)("span",{class:"token attr-value"},[(0,t._)("span",{class:"token punctuation attr-equals"},"="),(0,t._)("span",{class:"token punctuation"},'"'),(0,t.Uk)("app"),(0,t._)("span",{class:"token punctuation"},'"')]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token tag"},[(0,t._)("span",{class:"token punctuation"},"</"),(0,t.Uk)("div")]),(0,t._)("span",{class:"token punctuation"},">")]),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br")])],-1),C=(0,t._)("p",null,"js",-1),x=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 通過h函數創建vnode"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" vnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"h"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"div"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token keyword"},"class"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"counter"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" id"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"counter"'),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"h"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"h2"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"0"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"h"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"button"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token function-variable function"},"onClick"),(0,t._)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("counter"),(0,t._)("span",{class:"token operator"},"++"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"+1"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token comment"},"// 通過mount函數 將vnode掛載到#app上"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("vnode"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" document"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"querySelector"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},"'#app'"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br")])],-1),M=(0,t._)("p",null,"實際呈現的結構會是這樣的",-1),E=(0,t._)("p",null,[(0,t._)("img",{src:o,alt:"image20210912134806019"})],-1),V=(0,t._)("h3",{id:"patch函數比對更新舊節點",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#patch函數比對更新舊節點","aria-hidden":"true"},"#"),(0,t.Uk)(" patch函數比對更新舊節點")],-1),D=(0,t._)("p",null,"還要實現一個比對新舊節點，進行diff算法更新的patch函數，由於patch函數比較複雜，所以我們一步步拆開來看",-1),R=(0,t._)("p",null,"這個path函數將有兩個參數一個n1(舊節點)、一個是n2(新節點)，n1作為舊節點我們前面已經透過mount函數賦予了一個新的對應真實dom的屬性",-1),L=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token function-variable function"},"patch"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("n1"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" n2")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br")])],-1),P=(0,t._)("p",null,"我們第一步可以先判斷這兩個新舊節點的標籤是否一樣，如果不同我們可以直接對拿到舊節點的父元素，然後對整個舊節點進行替換",-1),A=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("tag "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(" n2"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("tag"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" parentNode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("parentNode\n    parentNode"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"removeChild"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("n2"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" parentNode"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br")])],-1),N=(0,t._)("p",null,"但是如果新舊節點的差別只有一點呢? 我們可以透過算法直接找到區別的地方進行替換就好，而這裡我們要先將獲取節點所對應的真實dom以方便之後修改並將舊節點對應真實dom的屬性保存到n2的屬性中",-1),O=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" el "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n2"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br")])],-1),q=(0,t._)("p",null,"然後對比新舊屬性的區別，並進行真實dom的更新",-1),H=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 處理props"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" oldProps "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props "),(0,t._)("span",{class:"token operator"},"||"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" newProps "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n2"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("props "),(0,t._)("span",{class:"token operator"},"||"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// 獲取所有新節點的props加到對應的元素中 如果判斷新舊props相同的就不用加"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" newProps"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" oldValue "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" oldProps"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" newValue "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" newProps"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldValue "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(" newValue"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token comment"},"// 對是否為on開頭的事件監聽做判斷"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"startsWith"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"on"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"addEventListener"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token number"},"2"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"toLowerCase"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newValue"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"setAttribute"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newValue"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token comment"},"// 刪除舊的props"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" oldProps"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 舊的事件要被移除掉避免多次掛載"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"startsWith"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"on"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"removeEventListener"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token number"},"2"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"toLowerCase"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" oldProps"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token comment"},"// 判斷新的props有沒有這個key，"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key "),(0,t._)("span",{class:"token keyword"},"in"),(0,t.Uk)(" newProps"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" \n    el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"removeAttribute"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"23"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"24"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"25"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"26"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"27"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"28"),(0,t._)("br")])],-1),S=(0,t._)("p",null,"接下來要處理新舊節點中各自的children，會有幾種可能，如果新的children是字符串最簡單，直接把舊的children用innerHTML替換掉就好，當然我們可以做更多的判斷，比如新舊children是否都是文本",-1),T=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" oldChildren "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n1"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" newChildren "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" n2"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("children"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token comment"},"// 情況一: newChildren本身是字符串"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" newChildren "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"string"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token comment"},"// 可以考慮更多的edge case(邊緣情況判斷)"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" oldChildren "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"string"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldChildren "),(0,t._)("span",{class:"token operator"},"!=="),(0,t.Uk)(" newChildren"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("textContent "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" newChildren"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("innerHTML "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" newChildren"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n   "),(0,t._)("span",{class:"token operator"},"..."),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br")])],-1),W=(0,t._)("p",null,"如果舊的children是字串而新的children是一個陣列(就是由多個h函數所組合的vnode)，可以直接遍歷然後進行mount掛載",-1),I=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// oldChildren是字串就直接清空並進行掛載"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"typeof"),(0,t.Uk)(" oldChildren "),(0,t._)("span",{class:"token operator"},"==="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"string"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("innerHTML "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'""'),(0,t.Uk)("\n  newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"forEach"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"item"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("item"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token operator"},"..."),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br")])],-1),J=(0,t._)("p",null,"如果新舊children都是陣列，就需要對陣列中的每個vnode進行比對，",-1),X=(0,t._)("blockquote",null,[(0,t._)("p",null,"oldChildren: [vnode1, vnode2, vnode3]"),(0,t._)("p",null,"newChildren: [vnode4, vnode5, vnode6]")],-1),Y=(0,t._)("p",null,"首先我們獲取新舊children最小的陣列長度，直接比對各個vnode進行更新，如果有新的children比較多就直接使用mount函數進行掛載，舊的children比較多則要移除",-1),Z=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" commonLength "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" Math"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"min"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"for"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" i "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token number"},"0"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i "),(0,t._)("span",{class:"token operator"},"<"),(0,t.Uk)(" commonLength"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i"),(0,t._)("span",{class:"token operator"},"++"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// console.log(i)"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"patch"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldChildren"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("i"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newChildren"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("i"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 比對新舊節點進行更新"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length "),(0,t._)("span",{class:"token operator"},">"),(0,t.Uk)(" oldChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 新節點的數量大於舊節點 對多出的節點進行掛載"),(0,t.Uk)("\n  newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"forEach"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"item"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("item"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length "),(0,t._)("span",{class:"token operator"},"<"),(0,t.Uk)(" oldChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 舊節點的數量大於舊節點 對多出的節點進行刪除"),(0,t.Uk)("\n  oldChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"slice"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("newChildren"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("length"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"forEach"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"item"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    el"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"removeChild"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("item"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("el"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br")])],-1),z=(0,t._)("h2",{id:"如何實現一個響應式系統",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#如何實現一個響應式系統","aria-hidden":"true"},"#"),(0,t.Uk)(" 如何實現一個響應式系統")],-1),B=(0,t._)("h3",{id:"dep類",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#dep類","aria-hidden":"true"},"#"),(0,t.Uk)(" Dep類")],-1),F=(0,t._)("p",null,"響應式的核心就是透過一個叫做dep的類實現依賴收集，所以我們首先要定義類，內部存放依賴這個變數的所有函數，當變數改變時這些函數也會被重新執行",-1),G=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"class"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Dep"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"constructor"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// subscribers中存放所有對應的依賴 "),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token comment"},"// 使用集合這樣的數據格式"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("subscribers "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(" \n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 負責收集依賴"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"depend"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("activeEffect"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("subscribers"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"add"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("activeEffect"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 通知依賴更新"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token function"},"notify"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)(" \n    "),(0,t._)("span",{class:"token keyword"},"this"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("subscribers"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"forEach"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"effect"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"effect"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br")])],-1),K=(0,t._)("h3",{id:"數據劫持",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#數據劫持","aria-hidden":"true"},"#"),(0,t.Uk)(" 數據劫持")],-1),Q=(0,t._)("p",null,"而如何監測數據改變呢，Vue3使用proxy對物件中各屬性的變化進行劫持，proxy中有兩個方法get和set，參數是target(物件)和key(屬性)",-1),$=(0,t._)("p",null,"通過這個reactive函數能劫持數據中的所有屬性，當屬性被調用或重新設置時都會調用getDep這個函數，獲取相應的dep類",-1),nn=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 透過reactive函數進行數據劫持"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"reactive"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"raw"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Proxy"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("raw"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" dep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"getDep"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"depend"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" target"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)("  "),(0,t._)("span",{class:"token comment"},"// proxy中target物件並非原物件 所以不會照成循環引用的問題"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newValue"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" dep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"getDep"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      target"),(0,t._)("span",{class:"token punctuation"},"["),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},"]"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" newValue\n      dep"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"notify"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("  \n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br")])],-1),sn=(0,t._)("p",null,"getDep函數是這樣的，使用weakmap這樣的結構來儲存該reactive物件對應的dep類，weakmap的好處是如果key值為null，對應的key和value都會被自動回收",-1),an=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 一般的map中key是一個字符串"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// weakmap中的key是一個物件 並且是弱引用的 意思是當key賦值為null時 這個key和對應的value都會被取消掉(垃圾回收)"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// 用weakmap是要將對應的原始數據做為key"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" targetMap "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"WeakMap"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"getDep"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},[(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" key")]),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 跟據傳入的target取targetMap中的dep集合"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" depsMap "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" targetMap"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("depsMap"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    depsMap "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Map"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    targetMap"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("target"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" depsMap"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token comment"},"// 從dep集合中取出key對應的dep"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" dep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" depsMap"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"get"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("dep"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    dep "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Dep"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    depsMap"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"set"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("key"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" dep"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(" dep\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"22"),(0,t._)("br")])],-1),tn=(0,t._)("h3",{id:"watcheffect",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#watcheffect","aria-hidden":"true"},"#"),(0,t.Uk)(" watchEffect")],-1),en=(0,t._)("p",null,"然後，我們還可以寫一個watchEffect函數來對傳入watchEffect內部的函數進行依賴收集",-1),on=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token comment"},"// 透過watchEffect這個函數加入dep的依賴中"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" activeEffect "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"function"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"watchEffect"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"effect"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  activeEffect "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" effect\n  "),(0,t._)("span",{class:"token function"},"effect"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 第一次自動執行"),(0,t.Uk)("\n  activeEffect "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br")])],-1),cn=(0,t._)("h2",{id:"實現一個createapp函數",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#實現一個createapp函數","aria-hidden":"true"},"#"),(0,t.Uk)(" 實現一個createApp函數")],-1),pn=(0,t._)("p",null,"最後要實現一個入口以供外部進行調用，示例:",-1),ln=(0,t._)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t._)("pre",{class:"language-javascript"},[(0,t._)("code",null,[(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(),(0,t._)("span",{class:"token function-variable function"},"createApp"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"rootComponent"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"=>"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token parameter"},"selector"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" container "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" document"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"querySelector"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("selector"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" isMounted "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"false"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token keyword"},"let"),(0,t.Uk)(" oldVnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token function"},"watchEffect"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"function"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token comment"},"// 判斷是否已經被掛載到dom上"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token keyword"},"if"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token operator"},"!"),(0,t.Uk)("isMounted"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n          oldVnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" rootComponent"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"render"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token function"},"mount"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldVnode"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" container"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          isMounted "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t._)("span",{class:"token boolean"},"true"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token keyword"},"const"),(0,t.Uk)(" newVnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" rootComponent"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"render"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token function"},"patch"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("oldVnode"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" newVnode"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          oldVnode "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" newVnode\n        "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n  "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"16"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"17"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"18"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"19"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"20"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"21"),(0,t._)("br")])],-1),un={},kn=(0,a(3744).Z)(un,[["render",function(n,s){return(0,t.wg)(),(0,t.iD)(t.HY,null,[c,p,l,u,k,_,i,r,U,b,d,m,h,f,v,g,y,w,j,C,x,M,E,V,D,R,L,P,A,N,O,q,H,S,T,W,I,J,X,Y,Z,z,B,F,G,K,Q,$,nn,sn,an,tn,en,on,cn,pn,ln],64)}]])},3357:(n,s,a)=>{n.exports=a.p+"assets/img/kslN7JI.ebd4dbf6.png"},1139:(n,s,a)=>{n.exports=a.p+"assets/img/xlUUnVs.2e360a06.jpg"}}]);